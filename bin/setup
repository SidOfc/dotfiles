#!/usr/bin/env bash

# {{{ Utility
function symlink() {
  if ln -fs "$1" "$2"; then
    echo "create symlink: $1 => $2"
  else
    echo "failed to link: $1 => $2"
  fi
}

trim() {
    local var="$*"
    var="${var#"${var%%[![:space:]]*}"}"
    var="${var%"${var##*[![:space:]]}"}"
    printf '%s' "$var"
}

function confirm() {
  local prompt="$1 (y/N): "
  while IFS=; read -s -r -n 1 -p "$prompt" choice; do
    prompt=""
    case "$choice" in
      [yY]* ) echo 'yes'; break;;
      "" | [nN]* ) echo 'no'; break;;
    esac
  done
}
# }}}

# {{{ Definitions
MACOS=$(uname -a | grep -i darwin)
REPO_ROOT=$(cd "$(dirname "$BASH_SOURCE")/../" && pwd)
SYMLINKS=$(trim "
$REPO_ROOT/config.fish        $HOME/.config/fish/config.fish
$REPO_ROOT/init.vim           $HOME/.config/nvim/init.vim
$REPO_ROOT/alacritty.yml      $HOME/.config/alacritty/alacritty.yml
$REPO_ROOT/gpg-agent.conf     $HOME/.gnupg/gpg-agent.conf
$REPO_ROOT/.asdfrc            $HOME/.asdfrc
$REPO_ROOT/.default-gems      $HOME/.default-gems
$REPO_ROOT/.gitconfig         $HOME/.gitconfig
$REPO_ROOT/.gitignore         $HOME/.gitignore
$REPO_ROOT/.rgignore          $HOME/.rgignore
$REPO_ROOT/.tmux.conf         $HOME/.tmux.conf
")
TOOLS=$(trim "
$HOME/.local/share/nvim/site/autoload/plug.vim
asdf
nvim
fzf
rg
fish
tmux
alacritty
autojump
gpg
gm
ffmpeg
youtube-dl
")
# }}}

# {{{ Check available tools
if test ! -z "$TOOLS"; then
  echo "tools:"
  while read exe_or_file; do
    if hash "$exe_or_file" 2>/dev/null; then
      echo "   installed: $exe_or_file"
    else
      echo "   missing:   $exe_or_file"
    fi
  done <<< "$TOOLS"
fi
# }}}

# {{{ Create symlinks
if test ! -z "$SYMLINKS"; then
  echo "symlinks:"
  for repo_and_dest in $(sed 's/\s\s\+/:/g' <<< "$SYMLINKS"); do
    repo_dotfile=$(cut -d':' -f1 <<< "$repo_and_dest")
    dest_dotfile=$(cut -d':' -f2 <<< "$repo_and_dest")

    if test -e "$repo_dotfile" && test ! -e "$dest_dotfile"; then
      answer=$(confirm "   create:    $dest_dotfile?")

      echo "$answer"
      [[ "$answer" = "yes" ]] && symlink "$repo_dotfile" "$dest_dotfile"
    elif ! test -e "$repo_dotfile"; then
      echo "   unknown:   $repo_dotfile"
    elif test -e "$dest_dotfile"; then
      answer=$(confirm "   overwrite: $dest_dotfile")

      echo "$answer"
      [[ "$answer" = "yes" ]] && symlink "$repo_dotfile" "$dest_dotfile"
    fi
  done
fi
# }}}

# {{{ macOS defaults
if $MACOS && hash "defaults" 2>/dev/null; then
  echo 'macOS defaults:'

  echo '   defaults write com.apple.finder AppleShowAllFiles YES'
  defaults write com.apple.finder AppleShowAllFiles YES

  echo '   defaults write com.apple.dock autohide-delay -float 1000; killall Dock'
  defaults write com.apple.dock autohide-delay -float 1000; killall Dock
fi
# }}}
